{% extends "base.html" %}

{% block about %}
<li class="about-dropdown">
  <a href="javascript:void(0)" class="about-dropbtn">About</a>
  <div class="about-content">
    <span>{{ info }}</span>
  </div>
</li>
{% endblock %}

{% block content %}
<div class="containers">
<br>
<div class="slidecontainer" style="float: left;">
  {% for slider in sliders %}
    <div style="float: left; padding-left: 2px; width: 49%;">
      {{ slider.id }}: <span id="{{'val_' + slider.id}}"></span><br>
      {% if slider.name == 'checkbox'%}
      <input id="{{ slider.id }}"
             class="{{ slider.class }}"
             type="{{ slider.type }}"
             onchange="flaskClient.setParam(this.id, this.checked)">
    </div>
      {% else %}
      <input id="{{ slider.id }}"
             class="{{ slider.class }}"
             name="{{ slider.name }}"
             type="{{ slider.type }}"
             min="{{ slider.min }}"
             max="{{ slider.max }}"
             step="{{ slider.step }}"
             value="0"
             onchange="flaskClient.setParam(this.id, this.value, this.name=='logarithmic')">
    </div>
      {% endif %}
  {% endfor %}
</div>
<br>


<button type="button" class="toggle"
        name="start" onclick="flaskClient.doAction(this)">Start</button>
<button type="button" class="toggle"
        name="pause" onclick="flaskClient.doAction(this)">Pause</button>
<button type="button" class="toggle"
        name="reset" onclick="flaskClient.doAction(this)">Reset</button>
<div style="float: right; padding-right: 5px;">
  <span id="ping-pong"></span>fps
</div>
</div>
<div id="data_display" style="position:relative;
                              width: 100%;
                              height: 100%;">
  <canvas id="density" style="z-index:1;
                              position:absolute;
                              left:0px;
                              top:0px;">
  </canvas>
  <canvas id="tracers" style="position:absolute;
	      		      z-index:2;
			      left:0px;
			      top:0px;">
  </canvas>
  <canvas id="finger" style="position:absolute;
                             z-index:3;
                             left:0px;
                             top:0px;">
  </canvas>
</div>

<script type="text/javascript"
        src="{{ url_for('static', filename = '/js/flask_client.js') }}">
</script>

<script>
  var flaskClient = FlaskClient('{{ model_name }}', document);
  
  // Establish namespace (model), websocket, and page width/height values
  var model = flaskClient.model;
  var socket = flaskClient.socket;
  
  // Auto-scale Model Animation to available window whitespace area.
  window.onload = window.onresize = flaskClient.on_resize;

  // When the User socket connection is made, start a server if not running
  socket.on('connect', function() {
    model.params = ['Nx', 'Ny', 'finger_x', 'finger_y'];
    //model.params = ['Nxy', 'finger_x', 'finger_y'];
    inputs = document.getElementsByTagName('input');
    for (index = 0; index < inputs.length; ++index) {
      model.params.push(inputs[index].id)
    };
    socket.emit('start_srv', {name: model.name, params: model.params})
  });

  // Gets current values (server side) of all relevant parameters.
  socket.on('init', function(data){
    Object.keys(data).forEach(key => {
      if (document.getElementById(key)) { // Make sure input exists first.
        if (document.getElementById(key).type == 'checkbox') {
          document.getElementById(key).checked = data[key];
          document.getElementById('val_' + key).innerHTML = data[key];
        }
        else if (document.getElementById(key).name == 'logarithmic'){
          document.getElementById(key).value = Math.log10(data[key]);
          document.getElementById('val_' + key).innerHTML = data[key];
        } else{
          document.getElementById(key).value = data[key];
          document.getElementById('val_' + key).innerHTML = data[key];
        }
    }
    });
    // Set sizing and finger positions.
    model.nx = data.Nx;
    model.ny = data.Ny;
    model.fx = flaskClient.fingerCanvas.canvas.width - data.finger_x*flaskClient.fingerCanvas.canvas.width;
    model.fy = data.finger_y*flaskClient.fingerCanvas.canvas.height;
 
  });

  // Receives rgba, external potential data and generates animation frames.
  // Also calculates framerate.
  socket.on('do_update', flaskClient.doUpdate);

  //Socket data reception to update user display for slider interactions,
  //regardless of which connected user interacted.
  socket.on('param_up', function(data) {
   let widget = document.getElementById(data.name);
   let value_label = document.getElementById('val_' + data.name);
   
   value_label.innerHTML = data.param;
   if (widget.type == 'checkbox') {
    widget.checked = data.param;
   } else if (widget.name == 'logarithmic') {
    widget.value = Math.log10(data.param);
   } else {
    widget.value = data.param;
   }
  });
  
  //When User navigates away from page, informs Flask framework to update user
  //count. This may result in computational server being shut down if room is
  //empty.
  window.onbeforeunload = function () {
    socket.emit('user_exit', {'data': model.name});
 }
</script>

{% endblock %}
